name: CI/CD - Build & Deploy to EKS

on:
  push:
    branches: [ "main" ]

permissions:
  id-token: write      # required for OIDC
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      ###############################################################
      # 1. Configure AWS credentials using OIDC
      ###############################################################
      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      ###############################################################
      # 2. Login to ECR
      ###############################################################
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      ###############################################################
      # 3. Build Docker image
      ###############################################################
      - name: Build Docker image
        run: |
          IMAGE_TAG="${{ github.sha }}"
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          docker build -t ${{ secrets.ECR_REPOSITORY }}:$IMAGE_TAG .

      ###############################################################
      # 4. Tag & Push to ECR
      ###############################################################
      - name: Tag & Push image to ECR
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          REGION=${{ secrets.AWS_REGION }}
          IMAGE_TAG=${{ env.IMAGE_TAG }}

          ECR_URL="$ACCOUNT_ID.dkr.ecr.$REGION.amazonaws.com/${{ secrets.ECR_REPOSITORY }}"

          docker tag ${{ secrets.ECR_REPOSITORY }}:$IMAGE_TAG $ECR_URL:$IMAGE_TAG
          docker push $ECR_URL:$IMAGE_TAG

          echo "IMAGE_URL=$ECR_URL:$IMAGE_TAG" >> $GITHUB_ENV

      ###############################################################
      # 5. Update kubeconfig for EKS
      ###############################################################
      - name: Update kubeconfig for EKS
        run: |
          aws eks update-kubeconfig \
            --region ${{ secrets.AWS_REGION }} \
            --name ${{ secrets.CLUSTER_NAME }}

      ###############################################################
      # 6. Deploy to Kubernetes
      ###############################################################
      - name: Deploy to EKS via kubectl
        run: |
          kubectl set image deployment/django-web \
            web=${{ env.IMAGE_URL }} \
            -n ecommerce

          kubectl rollout status deployment/django-web -n ecommerce

      ###############################################################
      # 7. Show cluster status for debugging
      ###############################################################
      - name: Show cluster resources
        run: |
          kubectl get nodes -o wide
          kubectl get pods -n ecommerce -o wide
          kubectl get svc -n ecommerce
